---
title: "Childbirth and delayed Parkinson’s onset: a reproducible non-biological artefact of societal change."
shorttitle: "Parkinson's and childbirth"

author: 
  - name          : "Michael R. MacAskill, PhD"
    affiliation   : "1,2"
    corresponding : yes    # Define only one corresponding author
    address       : "66 Stewart St, Christchurch 8011, New Zealand"
    email         : "michael.macaskill@nzbri.org"
  - name          : "Daniel J. Myall, PhD"
    affiliation   : "1"
  - name          : "Reza Shoorangiz, PhD"
    affiliation   : "1,3"
  - name          : "Tim J. Anderson, MD, FRACP"
    affiliation   : "1,2,4,5"
  - name          : "Toni L. Pitcher, PhD"
    affiliation   : "1,2,4"
affiliation:
  - id            : "1"
    institution   : "New Zealand Brain Research Institute, 66 Stewart St, Christchurch, New Zealand"
  - id            : "2"
    institution   : "Department of Medicine, University of Otago, Christchurch; Christchurch, New Zealand"
  - id            : "3"
    institution   : "Department of Electrical and Computer Engineering, University of Canterbury, Christchurch, New Zealand"
  - id            : "4"
    institution   : "Brain Research New Zealand, Rangahau Roro Aotearoa"
  - id            : "5"
    institution   : "Department of Neurology, Christchurch Hospital, Christchurch, New Zealand"

csl: format/sage-vancouver.csl
bibliography: format/selected_refs.bib
abstract: |
  **Background:** Uncontrolled studies have reported associations between later Parkinson's onset in women and a history of giving birth, with age of onset delayed by nearly three years per child.
  
  **Objectives:** We tested this association in two independent datasets but, as a control to test for non-biological explanations, also included men with Parkinson's.
  
  **Methods:** We analysed valid cases from the Parkinson's Progressive Markers Initiative incident sample (PPMI: 145 women, 276 men) and a prevalent sample surveyed by the New Zealand Brain Research Institute (NZBRI: 210 women, 394 men).
  
  **Results:** The association was present in both women and men in the PPMI study, and absent in both in the NZBRI study. This is consistent with generational differences, common to men and women, which confound with age of onset in incident-dominant samples.
  
  **Conclusion:** Despite being replicable in certain circumstances, associations between childbirth and later Parkinson's onset are an artefact of generational cohort differences.

keywords          : "Parkinson disease, sex differences, pregnancy, epidemiology,  cohort effects, sex hormones"
wordcount         : "Abstract: 150, main body: 1769"

floatsintext      : no
figurelist        : no
tablelist         : no
footnotelist      : no
linenumbers       : yes
mask              : no
draft             : no

documentclass     : "apa6"
classoption       : "man"
output            : papaja::apa6_word
---

```{r setup, include=FALSE}
###########################################################################
# The papaja package is used to format the resulting manuscript.
# It is not currently available on CRAN, so install from GitHub using devtools:
#
# install.packages('devtools')
# devtools::install_github('crsh/papaja')
###########################################################################
library(papaja)

knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE,
	dpi = 600 # for reasonable dpi in Word document bitmap figures
)

# allow complex kableExtra features to render in Word:
options(kableExtra.auto_format = FALSE)
```

```{r control}
rstan::rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())

###########################################################################
# fitting the models takes time, so set this variable to FALSE to allow 
# reading previously-fit models that have been saved to disk. THESE MODELS
# ARE NOT NECESSARILY PLATFORM-AGNOSTIC, SO THEY MAY NEED TO BE RECALCULATED 
# THE FIRST TIME THIS SCRIPT IS RUN ON A NEW COMPUTER:
RECALCULATE_MODELS = FALSE
###########################################################################

###########################################################################
# The Canterbury data requires matching survey responses to NZBRI-held info
# on diagnosis age. This will eventually break, as it relies on an old 
# internal processes to access data. So after the data sources were matched, 
# we saved them to a cached .csv file on disk and use that thereafter.
# This setting should be TRUE for people using the publicly-available
# distribution, as only this tidied and anonymised data is included:
USE_CACHED_CANTERBURY_DATA = TRUE
###########################################################################

###########################################################################
# The NZ national data required a lot of tidying. For convenience, one can 
# instead import the processed file. So after the data sources were matched, 
# we saved them to a cached .csv file on disk and use that thereafter.
# This setting should be TRUE for people using the publicly-available
# distribution, as only this tidied and anonymised data is included:
USE_CACHED_NATIONAL_DATA = TRUE
###########################################################################

###########################################################################
# We don't circulate the full PMMI datasets, which should be obtained 
# from the PPMI site directly. The following files are required if you want
# to follow how they were processed and joined:
# Patient_Status.csv
# Screening___Demographics.csv
# PD_Features.csv
# Family_History__PD_.csv
# 
# Otherwise, we include here the minimal resulting joined dataset, containing 
# just the crucial variables. This allows you to run this analysis without 
# access to the full PPMI tables:
USE_CACHED_PPMI_DATA = TRUE
###########################################################################

```

```{r import-packages, message=FALSE}
# currently need to suppress messages in this block as the tidyverse import 
# produces tick marks that throw off the latex rendering:
suppressMessages(library(tidyverse))
library(magrittr)   # for %<>%
library(knitr)      # for kable() function to format tables
library(kableExtra) # additional table formatting options
library(lubridate)  # manipulate dates
library(glue)       # construct formatted strings (neater than paste)
library(janitor)    # clean column names
library(brms)       # bayesian modelling
library(ggeffects)  # for visualising model predictions
library(cowplot)    # construct multi-panel figures
library(lme4)       # required by get_brms_formula

if (!USE_CACHED_CANTERBURY_DATA) {
  library(chchpd)   # NZBRI package to access study data
  chchpd::google_authenticate()
}
```


```{r define-variables}
# how many iterations to use in the model fitting.
# For Bayes factors require 10 × usual amount, compared to parameter estimation:
N_ITERATIONS = 20000

# specify manual colour scheme:
two_colours = c('#D55E00', '#0072B2')

ndigits <- function(number, digits = 1){
  return(format(round(number, digits = digits), nsmall = digits))
}

```

```{r import-nz-canterbury-data}
if (USE_CACHED_CANTERBURY_DATA) {
  
  # read from the previously merged and processed data set:
  dat_canty = read_csv('data/anonymised/nz_canterbury_data.csv')
  
} else # see what was required to merge & clean the various data sources:
{
  # data collected by Toni Pitcher via an online survey of NZBRI participants 
  # in 2014-15 and with new cases from 2018 appended:
  exposure_file = 'data/source/NZBRI/Environmental Exposures Relevant to PD_FINAL.csv'
  
  exposures = read_csv(exposure_file) %>% 
    janitor::clean_names() %>% 
    rename(survey_id = id_number_supplied_by_the_nzbri) %>% 
    # extract the date to be able to work out age at time of survey:
    mutate(survey_date = ymd(str_sub(timestamp, start = 1, end = 10))) %>% 
    # remove test ID values, which were non-numeric:
    mutate(survey_id = as.integer(survey_id)) %>% 
    filter(!is.na(survey_id)) %>% 
    # repair some erroneously-entered survey ids:
    mutate(survey_id = 
             case_when(survey_id == 2577 ~ 25577L,
                       survey_id == 3478 ~ 34827L,
                       survey_id == 8029 ~ 18029L,
                       survey_id == 23761 ~ 23764L,
                       survey_id == 30863 ~ 30683L,
                       survey_id == 7293 ~ 72937L,
                       TRUE ~ survey_id)) %>% 
    rename(how_many = how_many_children_do_you_have) %>% 
    mutate(how_many = str_to_lower(how_many)) %>% 
    mutate(n_children = 
             case_when(do_you_have_any_children == 'No' ~ 0,
                       how_many == '??' ~ NA_real_,
                       how_many %in% c('2 adopted', '2 boys who are adopted') ~ 0,
                       how_many %in% c('one', 'one {blood}') ~ 1,
                       how_many %in% c('2!', 'two', '2 children') ~ 2,
                       how_many == 'three' ~ 3,
                       how_many %in% c('four', '4 children', '4sons') ~ 4,
                       how_many == 'nine' ~ 9,
                       TRUE ~ as.numeric(how_many))) %>% 
    filter(!is.na(n_children)) %>% 
    # restrict to relevant variables:
    select(survey_id, survey_date, n_children)
  
  participants = chchpd::import_participants(identifiers = TRUE) %>% # as need DOB
    mutate(birth_year = year(birth_date)) %>% 
    select(subject_id, survey_id, participant_group, symptom_onset_age,
           diagnosis_age, birth_year, birth_date, sex)
  
  # join the exposure data to the participant data:
  dat_canty = exposures %>%
    left_join(participants, by = 'survey_id') %>% 
    mutate(age = round(interval(birth_date, survey_date) / years(1), digits = 1),
           duration_dx = round(age - diagnosis_age, digits = 1),
           duration_sx = round(age - symptom_onset_age, digits = 1))
  
  # identify those that didn't match (likely due to subject making
  # a manual data entry error of their subject id:)
  unmatched_survey = dat_canty %>% 
    filter(is.na(subject_id)) %>% 
    select(survey_id) %>%
    rename(unmatched_survey_id = survey_id)
  kable(unmatched_survey)
  
  # drop controls and one PSP case:
  dat_canty %<>% 
    filter(participant_group == 'PD') %>% 
    mutate(sex = factor(sex, levels = c('Female', 'Male'), 
                        labels = c('Women', 'Men')))
  
  # identify those that don't have a diagnosis age recorded in Alice:
  missing_diagnosis_age = dat_canty %>% 
    filter(is.na(diagnosis_age)) %>% 
    select(subject_id) %>%
    rename(missing_diagnosis_age = subject_id)
  kable(missing_diagnosis_age)
  
  # tidy up for mating to PPMI data:
  dat_canty %<>%
    filter(!is.na(diagnosis_age)) %>%
    mutate(study = 'NZBRI',
           substudy = 'Canterbury') %>%
    select(study, substudy, sex, n_children, symptom_onset_age, 
           diagnosis_age, birth_year, age, duration_dx, duration_sx) %>% 
    arrange(study, sex, n_children, diagnosis_age)
  
  # save merged data to a cached file:
  dat_canty %>% write_csv('data/anonymised/nz_canterbury_data.csv')
  
}

```

```{r import-nz-national-data}

if (USE_CACHED_NATIONAL_DATA) {
  
  # read from the previously merged and processed data set:
  dat_national = read_csv('data/anonymised/nz_national_data.csv')
  
} else # this was done to tidy and process the raw survey responses:
{
  # data collected by Toni Pitcher via a national online survey of Parkinson's 
  # NZ members, excluding people in Canterbury:
  national_file = 'data/source/NZBRI/Diagnosis, treatment and risk factors associated with Parkinson’s and related disorders in New Zealand..csv'
  # this dataset doesn't need to be joined to anything else, as it contains info
  # on both number of children as well as age of onset.
  
  dat_national = read_csv(national_file) %>% 
    janitor::clean_names() %>% 
    # filter out people who didn't consent:
    filter(i_understand_that_completing_this_survey_is_voluntary_and_my_ongoing_clinical_care_will_not_be_influenced_by_my_decision_about_this_survey == "Yes, I'm happy to complete the survey") %>% 
    # include only IPD:
    filter(what_disorder_have_you_been_diagnosed_with %in% c("Parkinson's disease", "Parkinson’s disease with dementia")) %>% 
    # extract the date to be able to work out age at time of survey:
    mutate(survey_date = ymd(str_sub(timestamp, start = 1, end = 10)),
           survey_year = year(survey_date)) %>% 
    rename(diagnosis_age = how_old_were_you_when_you_received_your_neurological_diagnosis,
           pre_diagnosis_years = how_long_were_you_aware_of_symptoms_of_your_neurological_condition_before_you_sought_a_medical_opinion,
           sex = what_sex_are_you,
           age = what_is_your_current_age,
           have_children = do_you_have_any_offspring_children,
           how_many = how_many_children_do_you_have,
           have_adopted = are_any_of_these_children_adopted_or_fostered_i_e_not_your_biological_child,
           how_many_adopted = how_many_of_your_children_are_not_your_biological_child) %>%
    select(survey_date,
           survey_year,
           diagnosis_age,
           pre_diagnosis_years,
           sex,
           age,
           have_children,
           how_many,
           have_adopted,
           how_many_adopted)
  
  # clean up the national data:
  dat_national %<>% 
    filter(!is.na(sex),
           sex != 'MTF') %>% 
    mutate(sex = factor(sex, levels = c('Female', 'Male'), 
                        labels = c('Women', 'Men'))) %>% 
    mutate_at(c('diagnosis_age', 'age', 'how_many'), str_to_lower) %>% 
    mutate_at(c('diagnosis_age', 'age', 'how_many'), str_remove_all, ' ') %>% 
    mutate(diagnosis_age = 
             str_remove(diagnosis_age, 
                        regex(str_c(c('yearsold', 'yrsold', '\\.5yearsold', '\\.5years',
                                      'years5months', 'yearsithink', 'yrslthink',
                                      'years', 'yrs', 'yr', 
                                      'about', '\\?', 'approx'), collapse = '|')))) %>% 
    mutate(diagnosis_age = case_when(diagnosis_age == 'sixty' ~ '60',
                                     diagnosis_age == '61andsxmonths' ~ '61',
                                     diagnosis_age == 'sixtyfive' ~ '65',
                                     diagnosis_age == 'age69.' ~ '69',
                                     diagnosis_age == 'seventy' ~ '70',
                                     diagnosis_age == 'seventyone' ~ '71',
                                     diagnosis_age == 'seventytwo' ~ '72',
                                     diagnosis_age == 'seventyfive' ~ '75',
                                     diagnosis_age == '8o' ~ '80',
                                     diagnosis_age == '5ago' ~ '-5',
                                     diagnosis_age == '2004' ~ '-15',
                                     diagnosis_age == '2006' ~ '-13',
                                     diagnosis_age == '2008' ~ '-11',
                                     diagnosis_age == '2016' ~ '-3',
                                     diagnosis_age == '7' ~ NA_character_,
                                     diagnosis_age == '11' ~ NA_character_,
                                     diagnosis_age == '77or78' ~ NA_character_,
                                     diagnosis_age == 'early40s' ~ NA_character_,
                                     diagnosis_age == 'didnothaveneurologicaldiagnosis' ~ NA_character_,
                                     diagnosis_age == 'alotdisapointed' ~ NA_character_,
                                     str_detect(diagnosis_age, 'dadwasalreadyaware') ~ NA_character_,
                                     TRUE ~ diagnosis_age)) %>% 
    filter(!is.na(diagnosis_age)) %>% 
    mutate(age = 
             str_remove(age, 
                        regex(str_c(c('yearsand11months', 'years6months', 'yrs6mths', 'yrs9mths', 'yearsold',
                                      'years', 'yrs', 'yr', 'y8m',
                                      '\\.6years','\\.5', 'tezs'), 
                                    collapse = '|')))) %>% 
    mutate(age = case_when(age == 'sixtyseventenmonths' ~ '67',
                           age == 'seventy-one' ~ '71',
                           age == 'eighty' ~ '80',
                           age == '668' ~ NA_character_,
                           age == '791' ~ NA_character_,
                           TRUE ~ age)) %>% 
    filter(!is.na(age))
  
  dat_national %<>% 
    # careful, this will wipe out any remaining that can't be parsed into numeric form:
    mutate_at(c('diagnosis_age', 'age'), as.numeric) %>% 
    filter(!is.na(diagnosis_age), !is.na(age)) %>% 
    # turn relative diagnosis years into absolute ages:
    mutate(diagnosis_age = case_when(diagnosis_age < 0  ~ diagnosis_age + age,
                                     TRUE ~ diagnosis_age))
  
  dat_national %<>%
    mutate(how_many = case_when(how_many == 'one'  ~ '1',
                                how_many == 'one.'  ~ '1',
                                how_many == '1adoptedson'  ~ '1',
                                how_many == '1alive,1deceased'  ~ '2',
                                how_many == 'two'  ~ '2',
                                how_many == 'twp'  ~ '2',
                                how_many == 'two-twins'  ~ '2',
                                how_many == '2adultdaughters'  ~ '2',
                                how_many == 'yesido.sonanddaugther'  ~ '2',
                                how_many == 'three'  ~ '3',
                                how_many == '3adults'  ~ '3',
                                how_many == '3birthsbut2livingsons'  ~ '3',
                                how_many == '3theyareadultsnow'  ~ '3',
                                how_many == 'four'  ~ '4',
                                how_many == '4sons'  ~ '4',
                                how_many == '4butonly2stillliving'  ~ '4',
                                how_many == 'five'  ~ '5',
                                # obfuscate some identifying values by not 
                                # stating entire search term:
                                str_detect(how_many, 'twonow,daughterpassedaway') ~ '3',
                                str_detect(how_many, '3onlytwolivingeldestdied') ~ '3',
                                TRUE ~ how_many)) %>% 
    # now wipe out any remaining that can't be parsed into numeric form:
    mutate(how_many = as.numeric(how_many)) %>% 
    # some stated they had children yet had NA for the number:
    filter(!(is.na(how_many) & have_children == 'Yes')) %>% 
    mutate(how_many = replace_na(how_many, 0),
           how_many_adopted = replace_na(how_many_adopted, 0)) %>% 
    mutate(n_children = how_many - how_many_adopted) %>% 
    # calculate various temporal variables:
    mutate(birth_year = survey_year - age,
           duration_dx = age - diagnosis_age) %>% 
    filter(duration_dx >= 0) %>% # one case was diagnosed at 83 but is age 68?
    # tidy up for mating to PPMI data:
    mutate(study = 'NZBRI',
           substudy = 'National') %>%
    select(study, substudy, sex, n_children, diagnosis_age, birth_year, age, 
           duration_dx) %>% 
    arrange(study, sex, n_children, diagnosis_age)

  
  # save processed data to a cached file:
  dat_national %>% write_csv('data/anonymised/nz_national_data.csv')
  
}


```

```{r import-ppmi-data}
# PPMI dates are often anonymised to be strings of the form 'MM/YYYY'. To do 
# calculations on these values requires that they become real date objects. We 
# coerce the values as.character in case they have been imported as a factor, 
# and set an arbitrary day of 15.
MMYYYYtoDate <- function(MMYYYY){
	return(
		dmy(paste('15/', as.character(MMYYYY),
							sep=''))
	)
}

# Similarly, DOBs are given as bare years, so we convert to a full year date 
# as at June 30:
YYYYtoDate <- function(YYYY){
	return(
		dmy(paste('30/6/', as.character(YYYY),
							sep=''))
	)
}

if (USE_CACHED_PPMI_DATA) {
  
  # read from the previously merged and minimised data set:
  dat_ppmi = read_csv('data/anonymised/ppmi_data.csv')
  
} else # if there is access to the full PPMI tables, merge them:
{
  # READ IN THE PARTICIPANT GROUP ASSIGNMENT:
  groups = read.csv('data/source/PPMI/Patient_Status.csv', 
                    stringsAsFactors = FALSE) %>% 
    select(PATNO, ENROLL_CAT, ENROLL_STATUS, ENROLL_DATE) %>% 
    filter(ENROLL_STATUS=='Enrolled' | ENROLL_STATUS=='Withdrew') %>% 
    filter(ENROLL_CAT != '') %>% 
    mutate(ENROLL_DATE = MMYYYYtoDate(ENROLL_DATE)) %>% 
    # exclude control, SWEDD, prodromal, genetics etc groups: 
    filter(ENROLL_CAT == 'PD')
  
  # READ IN THE YEAR OF BIRTH:
  YOBs = read.csv('data/source/PPMI/Screening___Demographics.csv', 
                  stringsAsFactors = FALSE) %>% 
    select(PATNO, BIRTHDT, GENDER) %>% # TODO some YOBs are missing NA
    # convert from bare years to a full date format:
    rename(birth_year = BIRTHDT) %>% 
    mutate(BIRTHDT = YYYYtoDate(birth_year))
  
  # get the date of PD diagnosis:
  # There is some double counting has been resolved:
  PD_dx_date = read.csv('data/source/PPMI/PD_Features.csv', 
                        stringsAsFactors = FALSE)  %>% 
    select(PATNO, PDDXDT, SXMO, SXYEAR) %>% 
    # construct a date for the symptom onset:
    unite(col = SXDT, SXMO, SXYEAR, sep = '/') %>% 
    # convert partial dates to true date format, adding a dummy day value:
    mutate(PDDXDT = MMYYYYtoDate(PDDXDT),
           SXDT = MMYYYYtoDate(SXDT)) %>% 
    # sort out duplicates:
    group_by(PATNO) %>% 
    summarise(PDDXDT = first(PDDXDT),
              SXDT = first(SXDT))
  
  FHx = read.csv('data/source/PPMI/Family_History__PD_.csv', 
                 stringsAsFactors = FALSE)
  
  dat_ppmi = left_join(groups, YOBs, by = 'PATNO') %>% 
    left_join(FHx %>% select(-EVENT_ID), by = 'PATNO') %>% 
    left_join(PD_dx_date, by = 'PATNO')
  
  dat_ppmi %<>% mutate(
    age = round(interval(BIRTHDT, ENROLL_DATE)/years(1), digits = 1),
    diagnosis_age = round(interval(BIRTHDT, PDDXDT)/years(1), digits = 1),
    symptom_onset_age = round(interval(BIRTHDT, SXDT)/years(1), digits = 1),
    duration_dx = round(age - diagnosis_age, digits = 1),
    duration_sx = round(age - symptom_onset_age, digits = 1),
    sex = case_when(GENDER == 0 ~ 0,
                    GENDER == 1 ~ 0,
                    GENDER == 2 ~ 1), # recode all women to female, regardless of child-bearing potential
    sex = factor(sex, labels = c('Women', 'Men'))) %>% 
    filter(!is.na(KIDSNUM)) # two people have missing KIDSNUM values
  
  dat_ppmi %<>%
    mutate(study = 'PPMI',
           substudy = 'PPMI') %>% 
    rename(n_children = KIDSNUM) %>% 
    select(study, substudy, sex, n_children, symptom_onset_age, diagnosis_age, 
           birth_year, age, duration_dx, duration_sx) %>% 
    arrange(study, sex, n_children, diagnosis_age)
  
  # save merged data to a cached file:
  dat_ppmi %>% write_csv('data/anonymised/ppmi_data.csv')
  
  ########
  # NB there are minor issues with -ve lags between SX and DX ages for 
  # 3 subjects.
  ########
}
```

```{r combine-data}
# combine data:
dat = bind_rows(dat_canty, dat_national, dat_ppmi) %>% 
  arrange(study, sex, n_children, diagnosis_age) %>% 
  mutate(study = factor(study, levels = c('PPMI', 'NZBRI'))) %>% 
  mutate(substudy = factor(substudy, 
                           levels = c('PPMI', 'Canterbury', 'National'))) %>%
  group_by(study) %>% 
  mutate(birth_year_std = birth_year - min(birth_year, na.rm = TRUE)) %>% 
  ungroup()


```

```{r fit-or-load-models, echo=FALSE, message=FALSE, warning=FALSE}
# decide whether to fit models from scratch, or save execution time by reloading
# models saved to disk previously:
if (RECALCULATE_MODELS) { 
  
  ########
  # Define priors
  # See https://github.com/stan-dev/stan/wiki/Prior-Choice-Recommendations
  #
  # Use weakly-informative priors for intercept and standard deviation of 
  # residuals.
  # For intercept: Student-t distribution, df = 3, mean = 0, scale = 10
  # For standard deviation of residuals: Student-t distribution, df = 3, 
  # mean = 0, scale = 10 with rejection sampling on the prior to ensure greater 
  # or equal to 0.
  # Matches the defaults for brms.
  #
  # Probability density function definition for the Student-t distribution:
  # https://mc-stan.org/docs/2_22/functions-reference/student-t-distribution.html
  #
  # To transform scale of Student-t to standard deviation:
  # https://jrnold.github.io/bugs-examples-in-stan/resistant.html
  # \sigma^{*} &amp;\sim \mathsf{HalfCauchy}{(0, 5)} \\
  # \sigma &amp;= \sigma^{*} \sqrt{\frac{\nu - 2}{\nu}} \\
  #
  # For Bayes Factors need proper priors on non-common parameter between model.
  # By default brms has improper priors on regression coefficients.
  # 
  # We use informative priors for the effect of number of children, based upon 
  # three previous studies cited in the paper: Haaxma et al. (2007), Yadav et 
  # al. (2012), and Frentzel et al. (2017).
  #
  # Older age == earlier birth year, thus reversal of sign for effect:
  # 
  # For  age: Normal distribution with mean =  2.5, sd = 2
  # For year: Normal distribution with mean = -2.5, sd = 2
  ########
  
  nchildren_onset_age_effect_prior_mean  =  2.5
  nchildren_birth_year_effect_prior_mean = -2.5  
  
  intercept_only_prior <- function(int_centre){
    df = 3
    int_scale = 10
    var_scale = 10
    return(c(prior_string(glue('student_t({df}, {int_centre}, {int_scale})'), 
                          class = 'Intercept'),
             prior_string(glue('student_t({df}, 0, {var_scale})'), 
                          class = 'sigma')))
  }
  
  nchildren_effect_prior <- function(int_centre,b_centre){
    df = 3
    int_scale = 10
    var_scale = 10
    b_scale = 2
    return(c(prior_string(glue('student_t({df}, {int_centre}, {int_scale})'), 
                          class = 'Intercept'),
             prior_string(glue('student_t({df}, 0, {var_scale})'), 
                          class = 'sigma'),
             prior_string(glue('normal({b_centre}, {b_scale})'), 
                          class = 'b')))
  }
  
  # fit the models from scratch and save them to disk:
  for (study_name in c('PPMI', 'NZBRI')) {
    
    med_diagnosis_age = dat %>% # needed for setting the prior
      filter(study == study_name) %>% 
      summarise(diagnosis_age = median(diagnosis_age)) %>% 
      pull() # extract as a scalar value
    
    # model for assessing sex group differences in mean onset age:
    model = brm(data = dat %>% filter(study == study_name), 
                diagnosis_age ~ sex, save_all_pars = TRUE,
                iter = N_ITERATIONS, sample_prior = TRUE,
                prior = nchildren_effect_prior(round(med_diagnosis_age),
                                               nchildren_onset_age_effect_prior_mean))
    
    saveRDS(model, glue('models/brm_{study_name}_dxage_sex.rds'))

    # models for looking at relationship with n_children within each sex:
    for (sex_level in c('Men', 'Women')) {
      
      med_diagnosis_age = dat %>% # needed for setting the prior
        filter(study == study_name, sex == sex_level) %>% 
        summarise(diagnosis_age = median(diagnosis_age)) %>% 
        pull() # extract as a scalar value
    
      #### The diagnosis-age associations            ###
      # first need an intercept-only model for each sex:
      model = brm(data = dat %>% filter(study == study_name,
                                        sex == sex_level), 
                  diagnosis_age ~ 1, save_all_pars = TRUE,
                  iter = N_ITERATIONS, sample_prior = TRUE,
                  prior = intercept_only_prior(round(med_diagnosis_age)))
      saveRDS(model, glue('models/brm_{study_name}_dxage_{sex_level}_int.rds'))
      
      # then compare that to a model as a function of n_children:
      model = brm(data = dat %>% filter(study == study_name,
                                        sex == sex_level), 
                  diagnosis_age ~ n_children, save_all_pars = TRUE,
                  iter = N_ITERATIONS, sample_prior = TRUE,
                  prior = nchildren_effect_prior(round(med_diagnosis_age),
                                                 nchildren_onset_age_effect_prior_mean))
      saveRDS(model, glue('models/brm_{study_name}_dxage_{sex_level}_n.rds'))
      
      med_birth_year = dat %>% # needed for setting the prior
        filter(study == study_name, sex == sex_level) %>% 
        summarise(birth_year = median(birth_year)) %>% 
        pull() # extract as a scalar value
      
      #### The birth-year cohort effects            ###
      # first need an intercept-only model for each sex:
      model = brm(data = dat %>% filter(study == study_name,
                                        sex == sex_level), 
                  birth_year ~ 1, save_all_pars = TRUE,
                  iter = N_ITERATIONS, sample_prior = TRUE,
                  prior = intercept_only_prior(round(med_birth_year)))
      saveRDS(model,
              glue('models/brm_{study_name}_birthyear_{sex_level}_int.rds'))
      
      # then compare that to a model as a function of n_children:
      model = brm(data = dat %>% filter(study == study_name,
                                        sex == sex_level), 
                  birth_year ~ n_children, save_all_pars = TRUE,
                  iter = N_ITERATIONS, sample_prior = TRUE,
                  prior = nchildren_effect_prior(round(med_birth_year),
                                                 nchildren_birth_year_effect_prior_mean))
      saveRDS(model, 
              glue('models/brm_{study_name}_birthyear_{sex_level}_n.rds'))
    }
    
  }
  }

# regardless, now read in the previously-fitted models from disk.
# construct the name of the model (e.g. 'brm_PPMI_dxage_int'):
for (study_name in c('PPMI', 'NZBRI')) {
  
  # first the dxage models:
  for (model_vars in c('sex', 'Men_int', 'Women_int', 'Men_n', 'Women_n')) {
    model_name = glue('brm_{study_name}_dxage_{model_vars}')
    
    # read its saved representation from disk:
    model = readRDS(glue('models/{model_name}.rds'))
    
    # assign to a variable with the associated name:
    assign(model_name, model)
    
    # for Women_n and Men_n models, predict values to get lines and intervals 
    # for depicting the models graphically, supplementing the raw data:
    if (str_ends(model_name, '_n')) {
      sex = str_sub(model_vars, start = 1, end = -3)
      prediction_name = glue('ggpredict_{study_name}_dxage_{model_vars}')
      prediction = ggpredict(model, terms = ~ n_children) %>%
        rename(n_children = x, diagnosis_age = predicted) %>% 
        mutate(sex = sex, study = study_name)
      assign(prediction_name, prediction)
    }
  }
  
  # then the birthyear ones
  for (model_vars in c('Men_int', 'Women_int', 'Men_n', 'Women_n')) {
    model_name = glue('brm_{study_name}_birthyear_{model_vars}')
    
    # read its saved representation from disk:
    model = readRDS(glue('models/{model_name}.rds'))
    
    # assign to a variable with the associated name:
    assign(model_name, model)
    
    # predict to get confidence intervals for graphing the fixed effects:
    if (str_ends(model_name, '_n')) {
      sex = str_sub(model_vars, start = 1, end = -3)
      prediction_name = glue('ggpredict_{study_name}_birthyear_{model_vars}')
      prediction = ggpredict(model, terms = ~ n_children) %>%
        rename(n_children = x, birth_year = predicted) %>% 
        mutate(sex = sex, study = study_name)
      assign(prediction_name, prediction)
    }
  }
}

# make dataframes that can be used for plotting the predicted values:
dxage_predictions = bind_rows(ggpredict_NZBRI_dxage_Men_n,
                              ggpredict_NZBRI_dxage_Women_n,
                              ggpredict_PPMI_dxage_Men_n,
                              ggpredict_PPMI_dxage_Women_n) %>% 
  mutate(study = factor(study, levels = c('PPMI', 'NZBRI')))

birthyear_predictions = bind_rows(ggpredict_NZBRI_birthyear_Men_n,
                                  ggpredict_NZBRI_birthyear_Women_n,
                                  ggpredict_PPMI_birthyear_Men_n,
                                  ggpredict_PPMI_birthyear_Women_n) %>% 
  mutate(study = factor(study, levels = c('PPMI', 'NZBRI')))

# tidy up orphaned references:
remove(model)
remove(prediction)
remove(list = ls(pattern = 'ggpredict_')) 

```

```{r extract-coefficients}
# the diagnosis age model coefficients:
PPMI_sex_coefs = fixef(brm_PPMI_dxage_sex)
PPMI_Men_n_coefs = fixef(brm_PPMI_dxage_Men_n)
PPMI_Women_n_coefs = fixef(brm_PPMI_dxage_Women_n)

NZBRI_sex_coefs = fixef(brm_NZBRI_dxage_sex)
NZBRI_Men_n_coefs = fixef(brm_NZBRI_dxage_Men_n)
NZBRI_Women_n_coefs = fixef(brm_NZBRI_dxage_Women_n)

# the relevant birth year effect model coefficients:
PPMI_Men_n_coefs_birth = fixef(brm_PPMI_birthyear_Men_n)
PPMI_Women_n_coefs_birth = fixef(brm_PPMI_birthyear_Women_n)

NZBRI_Men_n_coefs_birth = fixef(brm_NZBRI_birthyear_Men_n)
NZBRI_Women_n_coefs_birth = fixef(brm_NZBRI_birthyear_Women_n)
```


```{r show_priors_example, eval=FALSE, include=FALSE}
# To get the prior distributions. The default is a weakly informative prior, 
# i.e., a Student's t with 3 degrees of freedom, scale of 10, and mean of 
# variable mean.
prior_summary(brm_PPMI_birthyear_Men_n)

# If the sample_prior is set to TRUE at the time of model fitting, we can gather
# prior samples and visualise the prior distributions by:
bayesplot::mcmc_dens(prior_samples(brm_PPMI_birthyear_Men_n))

# To get full details of the model code and how priors are implemented:
stancode(brm_PPMI_birthyear_Men_n)

```

```{r p-women-later-onset}

# what is the probability that women actually have a later age of onset than men?
# can answer this by testing the specific hypothesis that their onset age difference is actually
# greater than zero:
p_ppmi_women_later_onset  = 
  brms::hypothesis(brm_PPMI_dxage_sex, 'sexWomen > 0')$hypothesis$Post.Prob
p_nzbri_women_later_onset = 
  brms::hypothesis(brm_NZBRI_dxage_sex, 'sexWomen > 0')$hypothesis$Post.Prob

# a more verbose way of saying the same thing:
#p_ppmi_women_later_onset = brms::hypothesis(brm_PPMI_sex, "Intercept + sexWomen > Intercept")$hypothesis$Post.Prob

# we could also do this manually, by looking at the proportion of posterior samples where the coefficient 
# was > 0:
# p_ppmi_women_later_onset = posterior_samples(brm_PPMI_sex) %>% 
#   mutate(above = b_sexWomen > 0) %>% 
#   summarise(prop = sum(above)/n())
 
```

```{r bayes-factors, include=FALSE}

# compare the diagnosis age slopes to the null model of no association:
BF_PPMI_Men = bayes_factor(brm_PPMI_dxage_Men_n, brm_PPMI_dxage_Men_int)
BF_PPMI_Women = bayes_factor(brm_PPMI_dxage_Women_n, brm_PPMI_dxage_Women_int)
BF_NZBRI_Men = bayes_factor(brm_NZBRI_dxage_Men_n, brm_NZBRI_dxage_Men_int)
BF_NZBRI_Women = bayes_factor(brm_NZBRI_dxage_Women_n, brm_NZBRI_dxage_Women_int)

# do the same for the cohort birth year effects:
BF_PPMI_Men_birth = bayes_factor(brm_PPMI_birthyear_Men_n, brm_PPMI_birthyear_Men_int)
BF_PPMI_Women_birth = bayes_factor(brm_PPMI_birthyear_Women_n, brm_PPMI_birthyear_Women_int)
BF_NZBRI_Men_birth = bayes_factor(brm_NZBRI_birthyear_Men_n, brm_NZBRI_birthyear_Men_int)
BF_NZBRI_Women_birth = bayes_factor(brm_NZBRI_birthyear_Women_n, brm_NZBRI_birthyear_Women_int)

# construct dataframes that can be used to overlay these BF values upon facets
# of their respective graphs:
BFs_dxage = tibble(study = rep(c('PPMI', 'NZBRI'), each = 2), 
                   sex = rep(c('Men', 'Women'), times = 2),
                   BF = c(BF_PPMI_Men$bf, BF_PPMI_Women$bf, 
                          BF_NZBRI_Men$bf, BF_NZBRI_Women$bf),
                   x = 7, y = 35) %>% 
  mutate(study = factor(study, levels = c('PPMI', 'NZBRI')))

BFs_birthyear = tibble(study = rep(c('PPMI', 'NZBRI'), each = 2), 
                       sex = rep(c('Men', 'Women'), times = 2),
                       BF = c(BF_PPMI_Men_birth$bf, BF_PPMI_Women_birth$bf, 
                              BF_NZBRI_Men_birth$bf, BF_NZBRI_Women_birth$bf),
                       x = 7, y = 1977) %>% 
  mutate(study = factor(study, levels = c('PPMI', 'NZBRI')))

```

# Introduction
The incidence of Parkinson’s is substantially lower in women [@taylor2007_HeterogeneityMaleFemale; @myall2017_ParkinsonOldestOld] (at least outside of China and Japan). [@taylor2007_HeterogeneityMaleFemale; @morozova2008_VariationsGenderRatios] The reason is unknown but could include greater male exposure to risk factors (e.g. head injury or occupational use of toxins), [@savica2013_RiskFactorsParkinson] or protective factors applying differentially to women (e.g. greater exposure to hormones like œstrogens and progestogens).

Plausible mechanisms have been proposed for how female sex hormones could play a neuroprotective role in neurodegenerative conditions[@roof2000_GenderDifferencesAcute] and hence observational studies have tested associations between increased hormone exposure and protection against Parkinson's. Lifetime hormonal exposure has been operationalised using endogenous measures such as fertile life span (the duration between age at menarche and at menopause), or exogenous exposure through oral contraceptives or hormone replacement therapy. Despite some positive findings, [@villa2016_EstrogensNeuroinflammationNeurodegeneration] most reviews [@ascherio2016_EpidemiologyParkinsonDisease], large prospective [@simon2009_ReproductiveFactorsExogenous] or case-control [@popat2005_EffectReproductiveFactors] studies, and meta-analyses [@lv2017_ReproductiveFactorsRisk;@du2014_HormoneReplacementTherapy] have shown little support for relationships between any such measures and a lowered risk of Parkinson’s.

Eight studies have examined the effect of parity (number of childbirths) upon the risk of women subsequently developing Parkinson’s. [@lv2017_ReproductiveFactorsRisk] Meta-analysis showed no effect, with the relative risk of Parkinson's between the highest and lowest number of births being 0.99 (95% CI: 0.79–1.25).[@lv2017_ReproductiveFactorsRisk] Three studies have, however, independently reported another childbirth-related association not specifically addressed in that meta-analysis: among women diagnosed with Parkinson’s, they found that a history of childbirth was associated with later age of onset. [@haaxma2007_GenderDifferencesParkinson; @yadav2012_CaseControlStudy; @frentzel2017_IncreaseReproductiveLife] That is, although having children might not reduce the risk of Parkinson’s _per se,_ it might still slow the pathological process. The associations were surprisingly large and consistent, with symptom onset reported as being later by 2.7 years (95% CI: 0.8 – 4.6, Netherlands, n = 97)[@haaxma2007_GenderDifferencesParkinson] or 2.6 years per childbirth (95% CI: 0.05 – 5.1, Germany, n = 79)[@frentzel2017_IncreaseReproductiveLife], or to have a correlation coefficient of 0.35 between parity and onset age (India, n = 81, p = 0.001).[@yadav2012_CaseControlStudy]

A challenge in such observational studies is applying valid control comparisons. Women without Parkinson's lack the disease outcome measures (such as age of onset), while men with Parkinson's lack the predictor hormonal measures. For this specific association, however, defining the predictor as "number of biological children" rather than "number of childbirths" allows men with Parkinson’s to be a suitable control for non-biological explanations. We propose that if the relationship between number of children and onset age is absent in men, it would strengthen claims for a protective female sex hormone effect. Conversely, if that relationship _does_ hold for men, it would strongly support the cause being non-biological.

\newpage

# Methods

## Data sets

*PPMI:* The openly-available Parkinson’s Progressive Marker Initiative is a dataset of incident cases, with a mean 7 months between diagnosis and recruitment (see Table \@ref(tab:demog-table) and Acknowledgments). Valid data on number of children was available from 421 of PPMI's 423 idiopathic Parkinson's cases.

*NZBRI:* At the New Zealand Brain Research Institute, we combined two previously-conducted risk-factor surveys, in which 604 people with idiopathic Parkinson's provided valid responses on age at diagnosis and number of biological children (Table \@ref(tab:demog-table)). Cases ranged from recently-diagnosed to those with long-standing disease. Responses were mostly collected online, with some submitting via paper or telephone. Respondents with dementia had assistance to complete the questions. One survey (`r nrow(dat_canty)` valid cases) recruited from our ongoing longitudinal study of a convenience sample of prevalent cases in the local Canterbury region. The other (`r nrow(dat_national)` valid cases) was nation-wide, recruiting from the membership (excluding Canterbury) of the Parkinson's New Zealand charitable trust. Age at diagnosis was self-reported in the national survey and confirmed from clinical records in the Canterbury survey. Canterbury respondents had diagnosis confirmed by a neurologist. The remainder required a diagnosis in order to receive care from Parkinson's New Zealand, which might have been made by a neurologist, other specialist, or general practitioner.

## Analyses
Onset age was defined as when Parkinson's was diagnosed, because symptom onset age was collected only in the local survey. Data were fit with simple Bayesian linear models, using the R[@rdevelopmentcoreteam2019_LanguageEnvironmentStatistical] package _brms_. [@burkner2017_BrmsPackageBayesian] Weakly-informative Student _t_ priors were used for the intercept (df = 3, mean = data mean, scale = 10) and standard deviation of the residuals (df = 3, mean = 0, scale = 10) with rejection sampling used to ensure the standard deviation was non-negative. The scale values were chosen so the prior distributions had moderate probability mass fully covering the range of plausible parameter values. Based upon the three previous studies, [@frentzel2017_IncreaseReproductiveLife; @haaxma2007_GenderDifferencesParkinson; @yadav2012_CaseControlStudy] we used a proper informative normal prior (mean = ±2.5, SD = 2) for the effect of the number of children (being positive for the dependent variable of age, and negative for year of birth). We ran four chains of 20 000 iterations each.

When testing hypotheses of associations between the number of children and age of onset (or year of birth), in each case we compared a model containing the number of children as a predictor to an intercept-only model (i.e. a model of no association). Bayes factors give the ratio of the likelihood of the data given a model including the number of children, to the likelihood of the data given an intercept-only ("flat-line") model.

## Reproducibility
The code and the anonymised dataset extracts used to conduct the analyses and generate this manuscript are available at https://github.com/nzbri/pd-parity.

```{r demog-table}
table_1 = dat %>% 
  group_by(study, sex) %>% 
  summarise(n = n(),
            age = 
              paste0(round(mean(age, na.rm = TRUE), digits = 1), ' (', 
                     round(sd(age, na.rm = TRUE), digits = 1), ')'),
            diagnosis_age = 
              paste0(round(mean(diagnosis_age, na.rm = TRUE), digits = 1), ' (', 
                     round(sd(diagnosis_age, na.rm = TRUE), digits = 1), ')'),
            duration = 
              paste0(round(mean(duration_dx, na.rm = TRUE), digits = 1), ' (', 
                     round(sd(duration_dx, na.rm = TRUE), digits = 1), ')'))

table_1 %>% 
  kable(col.names = c('Study', 'Sex', 'n', 'Mean age',
                      'Mean age at diagnosis', 
                      'Mean years disease duration'),
        caption = 'Demographic characteristics of the PPMI and NZBRI samples.',
        booktabs = TRUE) %>% # remove vertical gridlines
  column_spec(5:6, width = '2.5cm') %>% # wrap long column headers
  row_spec(0, bold = TRUE) %>% # bold header titles
  kable_styling(full_width = FALSE, position = 'center') %>% 
    collapse_rows(columns = 1, valign = 'middle') # PPMI and NZBRI labels span 2 rows

# extract some values for using in the text:
PPMI_mean_women_sx_duration = dat %>% 
  filter(study == 'PPMI', sex == 'Women') %>% 
  summarise(sx = mean(duration_sx, na.rm = TRUE)) %>% 
  pull() # make a single value

NZBRI_mean_women_dx_duration = dat %>% 
  filter(study == 'NZBRI', sex == 'Women') %>% 
  summarise(sx = mean(duration_dx, na.rm = TRUE)) %>%
  pull()

```

```{r histograms, eval=FALSE, include=FALSE}
dat %>% 
  ggplot(aes(x = diagnosis_age, fill = sex)) +
  facet_grid(sex ~ study) +
  geom_histogram(binwidth = 2) +
  scale_fill_manual(values = two_colours) +
  guides(fill = FALSE) +
  ylab('Frequency\n') +
  xlab('\nAge at diagnosis') +
  theme(axis.ticks = element_line(colour = 'lightgrey'),
        panel.grid.minor.x = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank())
  
```

\newpage

# Results

## PPMI sample

We first attempted to replicate the association between number of children and later disease onset in the PPMI women. The linearly-modelled delay in diagnosis was `r ndigits(PPMI_Women_n_coefs['n_children','Estimate'])` years per child (credible interval [`r ndigits(PPMI_Women_n_coefs['n_children','Q2.5'], 2)`, `r ndigits(PPMI_Women_n_coefs['n_children','Q97.5'])`]), being the slope of the line in the upper-right panel of Figure \@ref(fig:main-figure)B. However, a Bayes factor (BF) of `r ndigits(BF_PPMI_Women$bf)` indicated very weak evidence for an association compared to the intercept-only model. Stronger results were found for the PPMI men, with a slope of `r ndigits(PPMI_Men_n_coefs['n_children','Estimate'])` years per child [`r ndigits(PPMI_Men_n_coefs['n_children','Q2.5'])`, `r ndigits(PPMI_Men_n_coefs['n_children','Q97.5'])`], BF = `r ndigits(BF_PPMI_Men$bf)`. That the relationship occurred in men argues against the underlying cause being pregnancy- or birth-related.

For completeness, we also examined whether women did actually have a later age of disease onset. As indicated in Table \@ref(tab:demog-table), the mean age at diagnosis was similar between the sexes, occurring earlier for women by just `r ndigits(PPMI_sex_coefs['sexWomen','Estimate'])` [`r ndigits(PPMI_sex_coefs['sexWomen','Q2.5'])`, `r ndigits(PPMI_sex_coefs['sexWomen','Q97.5'])`] years.

## NZBRI sample

In the NZBRI sample, the slope for women was only `r ndigits(NZBRI_Women_n_coefs['n_children','Estimate'])` years per child [`r ndigits(NZBRI_Women_n_coefs['n_children','Q2.5'])`, `r ndigits(NZBRI_Women_n_coefs['n_children','Q97.5'])`], with a Bayes factor of `r ndigits(BF_NZBRI_Women$bf)` indicating strong evidence against an association.  The results were similar for men, with a slope of  `r ndigits(NZBRI_Men_n_coefs['n_children','Estimate'])` years per child [`r ndigits(NZBRI_Men_n_coefs['n_children','Q2.5'])`, `r ndigits(NZBRI_Men_n_coefs['n_children','Q97.5'])`], BF = `r ndigits(BF_NZBRI_Men$bf)`.

The NZBRI mean age at diagnosis was again similar between the sexes, occurring earlier for women by just `r ndigits(NZBRI_sex_coefs['sexWomen','Estimate'])` years  [`r ndigits(NZBRI_sex_coefs['sexWomen','Q2.5'])`, `r ndigits(NZBRI_sex_coefs['sexWomen','Q97.5'])`].

## Testing a non-biological alternative explanation

In many countries, due to late twentieth-century societal changes, older people on average had larger families than people born more recently. Figure \@ref(fig:main-figure)A shows such effects for the men and women in both studies. We then modelled how many years earlier we would expect a patient to have been born, given how many children they had. The coefficients are negative, as, for consistency across studies with recruitment at different times, we modeled year of birth rather than age. _PPMI study._ Women: `r ndigits(PPMI_Women_n_coefs_birth['n_children','Estimate'])` years per child, credible interval [`r ndigits(PPMI_Women_n_coefs_birth['n_children','Q2.5'], 2)`, `r ndigits(PPMI_Women_n_coefs_birth['n_children','Q97.5'])`], BF = `r ndigits(BF_PPMI_Women_birth$bf)`. Men: `r ndigits(PPMI_Men_n_coefs_birth['n_children','Estimate'])` years per child [`r ndigits(PPMI_Men_n_coefs_birth['n_children','Q2.5'], 2)`, `r ndigits(PPMI_Men_n_coefs_birth['n_children','Q97.5'])`], BF = `r ndigits(BF_PPMI_Men_birth$bf)`. _NZBRI study._ Women: `r ndigits(NZBRI_Women_n_coefs_birth['n_children','Estimate'])` years per child, [`r ndigits(NZBRI_Women_n_coefs_birth['n_children','Q2.5'], 2)`, `r ndigits(NZBRI_Women_n_coefs_birth['n_children','Q97.5'])`], BF = `r ndigits(BF_NZBRI_Women_birth$bf)` (although the association was not present in this sample, we know that the population fertility for New Zealand women did indeed decline markedly in the late twentieth century.[@pool2011_FamiliesHistoryColonial]) Men: `r ndigits(NZBRI_Men_n_coefs_birth['n_children','Estimate'])` years per child [`r ndigits(NZBRI_Men_n_coefs_birth['n_children','Q2.5'], 2)`, `r ndigits(NZBRI_Men_n_coefs_birth['n_children','Q97.5'])`], BF = `r ndigits(BF_NZBRI_Men_birth$bf)`.

```{r diagnosis-age-graph, fig.height=4, fig.width=4, message=FALSE, warning=FALSE}
# main result: age at diagnosis as a function of number of
# children, in each sex and for both sites:
diagnosis_panel = dat %>% 
	ggplot() +
  facet_grid(study ~ sex) + 
  geom_ribbon(data = dxage_predictions,
               aes(x = n_children,
                   ymin = conf.low, ymax = conf.high, fill = study), 
               colour = NA, alpha = 0.35) +
  geom_line(data = dxage_predictions, 
            aes(x = n_children,
                y = diagnosis_age),
            size = 0.25, linetype = 'solid') + # actual model fit
	geom_point(aes(x = n_children,
	               y = round(diagnosis_age, digits = 0), colour = study),
	               alpha = I(0.65), size = 0.6, 
	               position = position_jitter(width = 0.1, seed = 90210), 
	               shape = 16) +
  geom_text(data = BFs_dxage, aes(x = x, y = y,
                                  label = paste('BF[10] ==', round(BF, digits = 1))),
            family = 'Gill Sans', size = 7 * (5/14),
            parse = TRUE) + # parse the subscript notation
  scale_x_continuous(breaks = seq(from = 0, to = 9, by = 1)) +
  scale_y_continuous(breaks = seq(from = 30, to = 80, by = 10), 
                     expand = c(0, 0), limits = c(30, 90)) +
  scale_fill_manual(values = two_colours) +
  scale_colour_manual(values = two_colours) +
  guides(colour = FALSE, fill = FALSE) +
  xlab('Number of children') +
  ylab('Age at diagnosis') +
  theme_bw(base_family = 'Gill Sans') +
  theme(aspect.ratio = 1.25,
        axis.text = element_text(size = 7, colour = 'black'),
        axis.title = element_text(size = 10),
        axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0)),
        axis.title.y = element_text(margin = margin(t = 0, r = 0, b = 0, l = 0)),
        axis.ticks = element_line(colour = '#9A1D2B', size = 0.25),
        panel.border = element_rect(colour = '#9A1D2B', size = 0.5),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        strip.background = element_rect(colour = '#9A1D2B', fill = '#9A1D2B'),
        strip.text = element_text(colour = 'white', size = 10),
        plot.margin = unit(c(0.1, 0.1, 0.1, 0.25), 'cm'))

ggsave(plot = diagnosis_panel, 'figures/Age at diagnosis by n children.pdf', 
       device = cairo_pdf, width = 4, height = 4)

```

```{r birth-year-graph, fig.height=4, fig.width=4}
# plot the generational effect: number of children as a function
# of patient year of birth:
birthyear_panel = dat %>% 
  ggplot() +
  facet_grid(study ~ sex) +
  geom_ribbon(data = birthyear_predictions,
               aes(x = n_children,
                   ymin = conf.low, ymax = conf.high, fill = study), 
               colour = NA, alpha = 0.35) +
  geom_line(data = birthyear_predictions, 
            aes(x = n_children,
                y = birth_year),
            size = 0.25, linetype = 'solid') + # actual model fit
  geom_point(aes(x = n_children,
                 y = birth_year, colour = study), alpha = I(0.65),  size = 0.6,
             position = position_jitter(width = 0.1, seed = 90210), 
	           shape = 16) +
  geom_text(data = BFs_birthyear, aes(x = x, y = y,
                                  label = paste('BF[10] ==', round(BF, digits = 1))),
            family = 'Gill Sans', size = 7 * (5/14),
            parse = TRUE) + # parse the subscript notation
  coord_cartesian(clip = 'off') +
  scale_x_continuous(breaks = seq(from = 0, to = 9, by = 1)) +
  scale_y_reverse(breaks = c(1930, 1940, 1950, 1960, 1970, 1980), 
                     labels = c('1930', '', '1950', '', '1970', '')) +
  scale_fill_manual(values = two_colours) +
  scale_colour_manual(values = two_colours) +
  guides(colour = FALSE, fill = FALSE) +
  xlab('Number of children') +
  ylab('Patient year of birth') +
  theme_bw(base_family = 'Gill Sans') +
  theme(aspect.ratio = 1.25,
        axis.text = element_text(size = 7, colour = 'black'),
        axis.title = element_text(size = 10),
        axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0)),
        axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0)),
        axis.ticks = element_line(colour = '#9A1D2B', size = 0.25),
        panel.border = element_rect(colour = '#9A1D2B', size = 0.25),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        strip.background = element_rect(colour = '#9A1D2B', fill = '#9A1D2B'),
        strip.text = element_text(colour = 'white', size = 10),
        plot.margin = unit(c(0.1, 0.1, 0.1, 0.25), 'cm'))

ggsave(plot = birthyear_panel, 'figures/n children by year of birth.pdf', 
       width = 4, height = 4, device = cairo_pdf)

```

```{r main-figure, fig.width = 17/2.54, fig.height = 9.7/2.54, fig.cap="**(A).** In the PPMI (orange) and NZBRI (blue) studies, there was a background cohort effect in which older patients tended to have had more children than had patients who were born more recently (for ease of comparison with the age-of-onset associations, we plot number of children on the x-axis, although this does not reflect the direction of causality). The magnitude of this effect (i.e. the slope of each line) was such that each additional child was associated with the average patient having been born (approximately) one year earlier. The association was more strongly evident in men than in women in these samples. **(B).** PPMI is an incident study and hence patient age and age-of-diagnosis are tightly correlated. Accordingly, the PPMI age-of-diagnosis association almost perfectly reflects the underlying background societal association of older people having more children (at a similar magnitude of approximately one year per child). By contrast, the NZBRI survey was of a prevalent sample, in which a patient's current age and their age of diagnosis are no longer necessarily coupled. That is, a patient of a given age might have been recently diagnosed, or they could have long-standing disease. Accordingly, the age-of-diagnosis association was absent for both the NZBRI men and women (as indicated by the small BF (Bayes factor) values). Figure by MacAskill (2019), distributed at https://doi.org/10.6084/m9.figshare.9928460 under an open CC-BY 4.0 license.", dev='png', dev.args=list(type='cairo')}

figure_1 = cowplot::plot_grid(birthyear_panel, diagnosis_panel, 
                              align = 'v',
                              axis = 'bt', ncol = 2,
                              labels = c('A', 'B'),
                              label_x = c(0.00, 0.025),
                              label_y = 1.00)

print(figure_1)

ggsave(plot = figure_1, 
       filename = 'figures/Figure_1.pdf', width = 17, height = 9.7, 
       units = 'cm', device = cairo_pdf,)

ggsave(plot = figure_1, 
       filename = 'figures/Figure_1.png', width = 17, height = 9.7, 
       units = 'cm', dpi = 600, type = 'cairo')

```

\newpage

# Discussion

The PPMI men showed a clear association between having more children and later disease onset (although the dataset is limited by having few patients with more than four children). This is sufficient to discount the proposed hormonal cause for this relationship, previously reported in women only. [@haaxma2007_GenderDifferencesParkinson;@frentzel2017_IncreaseReproductiveLife;@yadav2012_CaseControlStudy] We tested a non-biological explanation, common to both men and women, in which older patients are simply more likely than younger ones to have had larger families. In incident studies like PPMI, there is a near-perfect correlation between patient age and age of diagnosis. Accordingly, the diagnosis-age effect in the PPMI study (top row, Figure \@ref(fig:main-figure)B) very closely resembles the simple background generational cohort effect (top row, Figure \@ref(fig:main-figure)A). The previously-reported associations are therefore likely an example of the classic epidemiological trap of mistaking an age effect for a generational cohort one. [@blanchard1977_DistinguishingAgingPeriod]

Associations between number of children and diagnosis age were absent in both sexes in the NZBRI study (bottom row, Figure \@ref(fig:main-figure)B), although the background generational effect (bottom row, Figure \@ref(fig:main-figure)A) was similar to that in the PPMI study. This is consistent, because in a prevalence sample, people with long-standing disease de-couple the relationship between patient age and the age of diagnosis. Consider one person diagnosed at age 50 and another at 75. In an incident study, with recruitment soon after diagnosis, these people would necessarily come from different generations. In a prevalent sample, however, this relationship breaks down. They could even be the same age, if one was recently diagnosed at age 75, while the other, also currently aged 75, had a 25 year history of disease. Artefactual associations between number of children and age of onset are therefore most likely in samples with a preponderance of incident cases. In a pure incident sample, the magnitude of the association should closely match the background societal association between age and family size (as shown in the roughly one-year-per-child associations in the PPMI sample). Two previous studies defined disease duration from symptom onset: with durations of 2.5 years [@haaxma2007_GenderDifferencesParkinson] and 5.8 years,[@frentzel2017_IncreaseReproductiveLife] this indeed places them closer to the PPMI incident study (`r ndigits(PPMI_mean_women_sx_duration, 1)` years mean female symptom duration) than to the NZBRI prevalent sample (where the mean duration since diagnosis was `r ndigits(NZBRI_mean_women_dx_duration, 1)` years, implying a much longer time relative to symptom onset). The third study had a median disease duration of 5 years although it was not specified if that was defined from symptom onset or diagnosis. [@yadav2012_CaseControlStudy] The magnitude of the effect we found (approximately one year later onset per child) was smaller than in the previous studies. This is consistent with the complex web of social, cultural, financial, and health factors that influence family size, with generational cohort being only one contributor (evident in the large variability in Figure \@ref(fig:main-figure)A).

If there was a causal association between childbirth and delayed disease onset, women's mean onset age should be measurably later than men's (unless some other competing female risk factors could somehow balance the putative protective childbirth effect). We found male and female onset age was similar, in both the PPMI and NZBRI samples. In the previous studies,  women's onset age (57.1) was either similar to men's (57.3),[@frentzel2017_IncreaseReproductiveLife] or non-significantly later (53.4 vs 51.3, p = 0.06)[@haaxma2007_GenderDifferencesParkinson] (the remaining study [@yadav2012_CaseControlStudy] had no male comparison). That is, not only is the association between childbirth and later disease onset artefactual, there is likely no female age-of-onset advantage in need of explanation. 

\newpage

# Acknowledgments
Some of the data used in the preparation of this article was obtained from the Parkinson's Progression Markers Initiative (PPMI) database (www.ppmi-info.org/data). For up-to-date information on the study, visit www.ppmi-info.org. PPMI – a public-private partnership – is funded by the Michael J. Fox Foundation for Parkinson's Research and funding partners, listed at www.ppmi-info.org/fundingpartners.

# Authors' Roles
MacAskill: Research project: conception. Statistical analysis: design, execution. Manuscript: writing of each draft.
Myall: Research project: execution. Statistical analysis: design, review. Manuscript: review and critique.
Shoorangiz: Statistical analysis: design, review. Manuscript: review and critique.
Anderson: Manuscript: review and critique.
Pitcher: Research project: conception, execution. Manuscript: review and critique.

# Relevant conflicts of interest/financial disclosures
Authors report no conflicts of interest. 
MacAskill, Anderson, and Pitcher are employed by the University of Otago. Myall and Shoorangiz are employed by the New Zealand Brain Research Institute. No other funding was obtained to carry out this specific project. The authors have jointly received funding for other projects in the past 12 months from the Neurological Foundation of New Zealand, New Zealand Brain Research Institute, Canterbury Medical Research Foundation, the University of Otago, and Brain Research New Zealand, Rangahau Roro Aotearoa.

# References

```{r review-figures}
# Produced to answer reviewer queries: not included in the manuscript itself.
# The question was whether diagnosis age was rising over time, which is not a 
# question that can be answered by either of these datasets (diagnosis occurred 
# only over a very narrow window for PPMI, and for NZBRI, the diagnosis window 
# spans decades, but a massive survivorship bias is in effect, meaning that the 
# apparent increase in diagnosis age over time is (at least mostly) artefactual: 
review_01_figure = dat %>% 
  ggplot(aes(x = birth_year + diagnosis_age, y = diagnosis_age)) + 
  facet_grid(. ~ study) +
  geom_point(alpha = 0.5, shape = 16, size = 0.5) +
  geom_smooth(method = 'lm', colour = 'red') +
  ylab('Age at diagnosis\n') + 
  xlab('\nYear of diagnosis') +
  theme_bw(base_family = 'Gill Sans') +
  xlim(c(1979, 2020)) +
  theme(axis.ticks = element_line(colour = 'lightgrey'),
        panel.border = element_rect(colour = 'lightgrey', size = 0.5),
        panel.grid.minor = element_blank(),
        strip.background = element_rect(colour = 'lightgrey', 
                                        fill = 'lightgrey'))

ggsave(plot = review_01_figure, 
       filename = 'figures/age_of_onset_over_time.png', 
       width = 17, height = 9.7, 
       units = 'cm', dpi = 600, type = 'cairo')

# In the second round of review, the question arose as to whether cohort effects
# could be corrected for by including year of birth in models, along with number
# of children. This figure shows that in PPMI, age of onset and year of birth
# are almost perfectly anti-correlated, and hence can't be included in the same 
# model. Due to the survivorship bias shown in the figure above, we claim that
# it shouldn't be included when modeling NZBRI data either:
review_02_figure = dat %>% 
  ggplot(aes(x = birth_year, y = diagnosis_age)) + 
  facet_grid(. ~ study) +
  geom_point(alpha = 0.5, shape = 16, size = 0.5) +
  geom_smooth(method = 'lm', colour = 'red') +
  ylab('Age at diagnosis\n') + 
  xlab('\nYear of birth') +
  theme_bw(base_family = 'Gill Sans') +
  theme(axis.ticks = element_line(colour = 'lightgrey'),
        panel.border = element_rect(colour = 'lightgrey', size = 0.5),
        panel.grid.minor = element_blank(),
        strip.background = element_rect(colour = 'lightgrey', 
                                        fill = 'lightgrey'))

ggsave(plot = review_02_figure, 
       filename = 'figures/feasibility_of_correcting_for_cohort.png', 
       width = 17, height = 9.7, 
       units = 'cm', dpi = 600, type = 'cairo')
```

